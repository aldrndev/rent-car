# 9.1 â€” Deployment Rules

## Purpose

Define deployment standards for all project profiles â€” from simple PaaS deployments to Docker-based VPS setups. Pragmatic and scaled to project needs.

## Deployment Targets (AUTHORITATIVE)

| Platform | Use Case | When |
|----------|----------|------|
| **Vercel** | Frontend (Next.js, Vite) | Default for web frontend |
| **Cloudflare Pages** | Frontend (static/SSR) | Alternative to Vercel |
| **Supabase** | Backend (Auth, DB, Edge Functions, Storage) | Serverless/free-tier projects |
| **Render** | Backend API | Free-tier or small paid projects |
| **Railway** | Backend API + DB | Small-mid projects |
| **VPS (Hostinger)** | Backend API + Docker | Paid client projects needing full control |
| **Fly.io** | Backend API (containerized) | Projects needing edge deployment |

## Frontend Deployment â€” Vercel / Cloudflare (AUTHORITATIVE)

### Vercel

- Connect to Git repo â€” auto-deploy on push to `main`
- Environment variables configured in Vercel dashboard (NOT committed)
- Preview deployments for PRs RECOMMENDED
- Build command and output directory MUST be correctly configured
- `vercel.json` for custom headers/redirects if needed

### Cloudflare Pages

- Connect to Git repo â€” auto-deploy on push
- Build settings configured in dashboard
- Environment variables in dashboard
- `_headers` and `_redirects` files for custom configuration

### Common Rules

- Production MUST deploy from `main` branch only
- ðŸŸ¡ Preview/staging deployments for PRs RECOMMENDED
- Environment variables MUST NOT be committed
- Public env vars MUST use framework prefix (`NEXT_PUBLIC_*`, `VITE_*`)

## Backend Deployment â€” Supabase (AUTHORITATIVE)

When using Supabase as the backend:

- RLS (Row Level Security) REQUIRED on all tables
- Edge Functions for custom server logic
- Database migrations via Supabase CLI (`supabase db push` or `supabase migration`)
- Service role key: server-side ONLY, never exposed to clients
- Supabase client in frontend: use anon key only
- ðŸŸ¡ Staging project RECOMMENDED (separate from production)

## Backend Deployment â€” VPS + Docker (AUTHORITATIVE)

For paid client projects on VPS (Hostinger, DigitalOcean, etc.):

### Docker (ABSOLUTE when using containers)

- Multi-stage builds REQUIRED
- Containers run as non-root user
- Image versions pinned (NO `latest` tag)
- Health checks REQUIRED
- `.env` files MUST NOT be baked into images
- Build ARG MUST NOT contain secrets
- Runtime secrets injected at container start

### docker-compose

- Allowed for local dev, CI, and single-node production
- Compose files MUST NOT contain secrets
- App services MUST use app-scoped `env_file`

```yaml
# compose structure
services:
  api:
    build: ./apps/api
    env_file: ./apps/api/.env
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
```

### ðŸŸ¡ Production Compose Rules

```
infra/compose/docker-compose.dev.yml        # local development
infra/compose/docker-compose.prod.yml       # production (VPS)
```

- Production compose MUST include:
  - Pinned images (by git SHA tag or explicit version)
  - Health checks gating
  - Restart policy (`unless-stopped`)
  - ðŸŸ¡ Resource limits (CPU/memory) for noisy-neighbor control

### Compose Default Values

- Non-secret defaults `${VAR:-default}` allowed
- Secret defaults FORBIDDEN
- Missing secrets MUST fail container startup

## Backend Deployment â€” Render / Railway (AUTHORITATIVE)

For free-tier or small backend deployments:

- Connect to Git repo â€” auto-deploy on push
- Environment variables in platform dashboard
- Health check endpoint REQUIRED (`/health`)
- ðŸŸ¡ Use platform's built-in PostgreSQL or connect to Supabase DB
- Sleep/cold-start behavior: acceptable for free-tier, document for client

## CI/CD Pipeline (AUTHORITATIVE)

### ðŸŸ¢ Minimum CI (All Projects)

On every push / PR:

1. Lint (`pnpm lint`)
2. Typecheck (`pnpm typecheck`)
3. Build (`pnpm build`)
4. Unit tests (`pnpm test`)

Merge to main FORBIDDEN if CI fails.

### ðŸŸ¡ Standard CI (Mid-Size Projects)

Extends minimum CI with:

5. Integration tests
6. Dependency scan (`pnpm audit`)
7. ðŸŸ¡ Secret scanning

### ðŸ”´ Full CI (Production-Critical)

Extends standard CI with:

8. E2E tests
9. Container image build + scan
10. SBOM generation
11. Artifact digest verification

### CD Rules

- ðŸŸ¢ Production deploys from `main` only
- ðŸŸ¢ CI MUST be green before deploy
- ðŸŸ¡ Automated deployment (push to main â†’ auto-deploy) RECOMMENDED
- ðŸŸ¡ Rollback MUST be possible (redeploy previous version)
- ðŸ”´ Blue/green or rolling deploy for zero-downtime
- ðŸ”´ Canary deploy for gradual rollout

## Environment Strategy (AUTHORITATIVE)

### ðŸŸ¢ Minimum (Small Projects)

```
main branch â†’ Production
```

### ðŸŸ¡ Standard (Client Projects)

```
feature branch â†’ Preview/Staging (auto-deploy PR)
main branch    â†’ Production
```

### ðŸ”´ Full (Large Projects)

```
feature branch â†’ Preview
main branch    â†’ Staging (auto)
manual trigger â†’ Production
```

## Environment Variables (ABSOLUTE)

- `NODE_ENV` MUST be: `development`, `staging`, or `production`
- Default `NODE_ENV` FORBIDDEN
- Env MUST be validated at startup with Zod â€” missing required env MUST crash
- Silent fallbacks for secrets FORBIDDEN

### Per-Platform Env Rules

| Platform | How to Set Env |
|----------|---------------|
| Vercel | Dashboard â†’ Settings â†’ Environment Variables |
| Cloudflare | Dashboard â†’ Settings â†’ Environment Variables |
| Supabase | Dashboard â†’ Edge Functions â†’ Secrets |
| Render | Dashboard â†’ Environment |
| Railway | Dashboard â†’ Variables |
| VPS/Docker | `.env` file (not committed) or secret manager |

## Health Checks (ABSOLUTE)

Every deployed backend MUST have:

```typescript
// GET /health
{
  status: 'ok',
  timestamp: '2026-01-01T00:00:00.000Z',
  version: '1.0.0'  // from package.json or git SHA
}
```

- Health check MUST verify: app is running, basic connectivity
- ðŸŸ¡ Health check SHOULD verify: database reachable, Redis reachable
- Health check MUST NOT expose sensitive information

## Production Safety (AUTHORITATIVE)

- ðŸŸ¢ Health checks REQUIRED and MUST gate traffic
- ðŸŸ¢ Rollback MUST be possible within minutes
- ðŸŸ¡ Automated backups REQUIRED for databases
- ðŸŸ¡ Monitoring / uptime check RECOMMENDED (UptimeRobot, Better Stack)
- ðŸ”´ Multi-AZ / multi-region for high-availability (record as limitation if not available)
- ðŸ”´ Disaster recovery plan documented
- ðŸ”´ SLOs defined and monitored

## SSL / Domain (ABSOLUTE)

- HTTPS REQUIRED for all production deployments
- Vercel/Cloudflare/Render/Railway: SSL is automatic
- VPS: use Let's Encrypt with auto-renewal (certbot or Caddy)
- Custom domains MUST have proper DNS configuration
- HTTP â†’ HTTPS redirect REQUIRED
