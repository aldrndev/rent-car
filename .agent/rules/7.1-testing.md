# 7.1 â€” Testing Rules

## Purpose

Risk-driven, deterministic, long-lived testing that catches real bugs. Tests MUST prove the system works correctly, not just that it compiles.

## Priority (ABSOLUTE)

Testing priorities follow 1.1-core.md:

1. Security & Correctness
2. Reliability
3. Maintainability
4. Performance (as needed)

## Test Tooling (AUTHORITATIVE)

| Tool | Use | When |
|------|-----|------|
| **Vitest** | Unit + Integration tests | Default for all web + backend projects |
| **Jest** | Unit + Component tests | React Native / Expo projects only |
| **Playwright** | E2E tests | All web projects needing E2E |
| **Supertest** | HTTP integration tests | Backend API route testing |
| **Testing Library** | Component tests | React + React Native |
| **Testcontainers** | ðŸŸ¡ DB/Redis in CI | Backend integration tests |

- Vitest PREFERRED over Jest for all non-RN projects (faster, native ESM + TS)
- Jest ONLY for React Native (Vitest does not support RN runtime)
- Playwright PREFERRED over Cypress (cross-browser, faster, native parallelism)

## Core Principles (ABSOLUTE)

### Determinism

- Tests MUST be deterministic â€” same input = same result, every time
- Tests MUST NOT rely on: real time, randomness without seed, real network, external SaaS
- Arbitrary sleeps FORBIDDEN â€” use readiness signals + bounded timeouts
- Snapshot tests FORBIDDEN

### Hermetic Environment

- ðŸŸ¡ CI test jobs SHOULD run with no external network calls
- External SaaS calls during tests FORBIDDEN
- ðŸŸ¡ Testcontainers images MUST be pinned to exact versions (no `latest`)

### What to Test

- Assert observable behavior and invariants â€” NOT internal implementation
- Mocking allowed ONLY at boundaries: network, filesystem, external APIs
- Mocking internal layers (service â†” repository) FORBIDDEN

## Scope Model (AUTHORITATIVE)

Apply based on project profile:

| Profile | Scope |
|---------|-------|
| **F** (Frontend) | Unit + Component + ðŸŸ¡Integration + ðŸŸ¡E2E(light) |
| **B** (Backend) | Unit + Integration + Contract + Security |
| **M** (Mobile) | Unit + Component + Contract + ðŸŸ¡Smoke Navigation |
| **FB** (Fullstack) | All of F + B + Contract |
| **FBM** (Monorepo) | ALL + Cross-package |
| **S** (Supabase) | Unit + Component + ðŸŸ¡Integration + RLS tests |

When multiple scopes apply, strictest wins.

## Test Taxonomy

### 1. Unit Tests (REQUIRED)

- Pure logic, invariants, utilities
- No DB, no HTTP, no real FS, no external APIs
- MUST cover: state machines, validation edge cases, business rules
- Fast â€” should run in < 1 second each

### 2. Integration Tests (ðŸŸ¡ STANDARD)

Backend:
- Boot real Fastify app (with global error handler, auth hooks)
- ðŸŸ¡ Use Testcontainers for Postgres/Redis
- Fresh DB per run with migrations applied
- Test: tenant scoping, transactions, error shapes, pagination

Frontend:
- Component rendering with React Query + mocked API
- Test: routing, query invalidation, error boundaries

### 3. Contract Tests (ðŸŸ¡ STANDARD)

- Validate frontend/mobile against backend API contracts
- Zod schemas are the source of truth
- MUST cover: request/response DTOs, error shape, API versioning

### 4. E2E Tests (ðŸŸ¡ STANDARD â€” Minimal)

**Tool: Playwright**

- Small, stable suite â€” critical flows only
- Snapshot assertions FORBIDDEN
- Arbitrary sleeps FORBIDDEN â€” use Playwright auto-wait
- Run in headless mode in CI

Mandatory categories (if applicable):
1. Auth establishment (login/logout)
2. Primary happy path
3. Critical error handling

Budget:
- CI total â‰¤ 5 minutes for E2E
- No new E2E unless introducing new critical flow

### 5. Smoke Tests (REQUIRED)

- Health endpoint (`/health`)
- App boots without crash
- Dependencies reachable (in dev/staging)

### 6. Regression Tests (REQUIRED)

- Every bug fix MUST include a regression test
- Prefer unit/integration over E2E for regression

### ðŸŸ¡ 7. Security Tests (AUTHORITATIVE)

As applicable:
- IDOR (accessing another user's resource returns 404)
- Mass assignment (extra fields are ignored)
- Non-leak masking (denied access returns 404, not 403)
- Safe errors (no internal IDs or stack traces in responses)

### ðŸ”´ 8. Performance Tests (As Needed)

- Nightly/on-demand, not on every PR
- Validate: p95/p99 latency, backpressure, bounded retries

## Backend-Specific Test Rules

- Integration tests MUST boot real Fastify with auth hooks enabled
- Test-only auth bypass FORBIDDEN
- Setup: seed users/sessions tenant-scoped OR execute login flow
- ðŸŸ¡ Multi-tenancy tests: same-tenant success + cross-tenant denial
- Error tests: assert stable `errorCode` + safe message + status + `requestId`

## Frontend-Specific Test Rules

Allowed:
- Unit (utils, selectors, hooks)
- Component (observable behavior)
- Integration (routing + React Query with mocked API)
- E2E (critical flows only)

Forbidden:
- Snapshot tests
- Testing hook internals directly
- Direct fetch usage in tests

## Mobile-Specific Test Rules

MUST cover:
- Secure storage usage patterns
- Auth persistence rules
- Contract/schema validation
- ðŸŸ¡ Smoke navigation flows (basic screen renders)

## Test Co-Change Rule (ABSOLUTE)

- Production code changes MUST include corresponding tests
- Negative tests REQUIRED for high-risk paths
- PR/commit is INVALID if production logic changes without tests

### High-Risk Domains (MUST Always Have Tests)

- ðŸŸ¢ Validation logic (Zod schemas + edge cases)
- ðŸŸ¢ Business rules (state machines, calculations)
- ðŸŸ¡ Authorization policies (deny-by-default)
- ðŸŸ¡ Tenant isolation (if multi-tenant)
- ðŸŸ¡ Webhook verification (if applicable)
- ðŸŸ¡ Job idempotency (if using background jobs)

## CI Test Gates (ðŸŸ¡ STANDARD)

Required on every PR:

1. Lint
2. Typecheck
3. Unit tests
4. ðŸŸ¡ Integration tests
5. ðŸŸ¡ Contract tests
6. ðŸŸ¡ Dependency scan

E2E scheduling:
- Smoke E2E on PR (optional)
- Full E2E on merge to main (recommended)

## Flakiness Policy (ABSOLUTE)

- Test retries FORBIDDEN by default
- Flaky tests MUST be fixed immediately or quarantined with:
  - Test name, owner, issue reference, expiry date
- After expiry: test MUST be fixed or removed
