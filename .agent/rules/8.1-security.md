# 8.1 â€” Security Rules

## Purpose

Define security standards aligned with OWASP best practices. Security is the #1 priority (see 1.1-core.md). These rules apply to all platforms: web, backend, and mobile.

## Secrets Management (ABSOLUTE)

- Secrets NEVER committed to version control
- `.env.example` REQUIRED (with placeholder values, no real secrets)
- `.env` MUST be in `.gitignore`
- Secrets MUST NOT have default values in code
- Secrets MUST NOT be logged
- Secrets MUST NOT be present in client bundles
- Secrets MUST NOT be baked into Docker images
- Production secrets injected via environment variables at runtime

## Authentication (ABSOLUTE)

- Token-based auth ONLY
- Passwords hashed with argon2 (bcrypt acceptable as fallback)
- Password requirements: minimum 8 characters, no maximum length cap below 128

### Token Storage

| Platform | Storage | Notes |
|----------|---------|-------|
| Web | HttpOnly + Secure + SameSite cookies | `localStorage` for tokens FORBIDDEN |
| Mobile | expo-secure-store (Keychain/Keystore) | `AsyncStorage` for tokens FORBIDDEN |

### ðŸŸ¡ Hybrid Token Model (AUTHORITATIVE)

For projects implementing custom auth (not Supabase Auth):

#### Access Token

- Stateless JWT signed with `jose`
- Short-lived: MAX 15 minutes
- Mandatory claims: `iss`, `aud`, `sub`, `iat`, `exp`, `nbf`
- Algorithm allowlist REQUIRED â€” `alg=none` FORBIDDEN
- `kid` REQUIRED for key identification
- Payload minimal â€” no PII
- Clock skew tolerance MUST be explicitly defined

#### Refresh Token

- Opaque random token (minimum 32 bytes) â€” NOT a JWT
- Stored as hash in database (never plaintext)
- Never logged, never sent to client in response body (cookie only for web)

#### ðŸŸ¡ Refresh Rotation & Replay Detection

- Rotate on EVERY refresh â€” tokens are single-use
- Token family model REQUIRED
- Reuse of a rotated refresh token MUST revoke the entire family (compromise detection)

#### ðŸŸ¡ Key Management

- Key ring REQUIRED (1 active signing key, multiple verification keys)
- Rotation MUST NOT log out active users
- Hardcoded keys FORBIDDEN

### Supabase Auth

When using Supabase Auth instead of custom auth:

- Use Supabase client SDK for auth flows
- Token management handled by Supabase â€” do not implement custom JWT
- RLS (Row Level Security) REQUIRED on all tables
- Service role key MUST NOT be exposed to clients
- Anon key is safe for client-side â€” but RLS MUST enforce access

## Authorization (ABSOLUTE)

- Server-side authorization on EVERY request (zero-trust)
- Deny-by-default policy REQUIRED
- IDOR protection REQUIRED â€” validate resource ownership on every access
- Sequential/guessable IDs FORBIDDEN â€” use UUID, nanoid, or cuid2

### Non-Leak Rule

- Unauthorized access MUST return generic 404 (NOT 403)
- Resource existence MUST NOT be inferable from responses
- ðŸŸ¡ Denied access attempts SHOULD be logged for audit

### ðŸŸ¡ Tenant Isolation (Multi-Tenant Projects)

- `tenantId` MUST be enforced at the repository/query layer
- Unscoped queries FORBIDDEN â€” every DB query MUST filter by tenant
- Cross-tenant data access MUST be impossible

## Input Validation â€” OWASP (ABSOLUTE)

### A03:2021 â€” Injection

- ALL user input validated with Zod before processing
- Parameterized queries ONLY (Prisma handles this by default)
- Raw SQL FORBIDDEN unless in a transaction with explicit validation
- Template literals for SQL FORBIDDEN

### A01:2021 â€” Broken Access Control

- Authorization checked on every endpoint â€” not just at route level
- Mass assignment FORBIDDEN â€” explicit DTO allowlist REQUIRED
- File upload: validate type, size, and content (not just extension)

### A02:2021 â€” Cryptographic Failures

- HTTPS everywhere (enforced at deployment level)
- Sensitive data encrypted at rest when applicable
- No custom cryptography â€” use proven libraries (`jose`, `argon2`)

### A04:2021 â€” Insecure Design

- Security reviews part of planning (see 2.1-planning.md)
- Rate limiting REQUIRED on auth endpoints
- Account lockout or exponential backoff REQUIRED after failed attempts

### A05:2021 â€” Security Misconfiguration

- Security headers REQUIRED:

```
Content-Security-Policy: frame-ancestors 'self'
X-Content-Type-Options: nosniff
Referrer-Policy: strict-origin-when-cross-origin
Permissions-Policy: camera=(), microphone=(), geolocation=()
X-Frame-Options: DENY
```

- Default error pages MUST NOT reveal stack traces or internal info
- Directory listing MUST be disabled
- CORS MUST be explicitly configured (not `*` in production)

### A07:2021 â€” XSS

- React/JSX auto-escapes by default â€” do NOT bypass with `dangerouslySetInnerHTML`
- `dangerouslySetInnerHTML` FORBIDDEN unless with DOMPurify sanitization
- User-generated content MUST be sanitized before rendering
- CSP headers MUST restrict inline scripts

### A08:2021 â€” SSRF

- ðŸŸ¡ SSRF protection REQUIRED for any user-provided URLs
- Private IP ranges MUST be blocked
- DNS rebinding defense RECOMMENDED
- URL allowlisting preferred over blocklisting

### A09:2021 â€” Logging & Monitoring

- See 4.1-backend.md for logging rules
- Security events MUST be logged: auth failures, permission denials, suspicious activity
- ðŸŸ¡ Logs MUST NOT contain: passwords, tokens, full PII, credit card numbers

## CSRF Protection (AUTHORITATIVE)

- CSRF protection REQUIRED when using cookie-based auth
- SameSite cookie attribute REQUIRED (`Lax` minimum, `Strict` preferred)
- For API-only backends using Bearer tokens: CSRF protection not needed

## ðŸŸ¡ Webhooks (AUTHORITATIVE)

If receiving webhooks from external services:

- Signature verification REQUIRED (HMAC or equivalent)
- Timestamp verification REQUIRED (reject old timestamps)
- Replay protection REQUIRED (track processed webhook IDs)
- Idempotent processing REQUIRED
- Webhook payloads MUST NOT be logged (store hash/IDs only)

## ðŸŸ¡ Audit Logging (AUTHORITATIVE)

For projects that need compliance/audit trails:

- Append-only event log for: auth events, admin actions, data exports, deletes
- Application role MUST NOT have update/delete permission on audit tables
- Correlation via `requestId` REQUIRED
- ðŸ”´ Tamper detection REQUIRED for regulated environments

## Mobile Security Additions (ABSOLUTE)

- SSL/TLS for all network requests (enforced by default in Expo)
- Certificate pinning OPTIONAL â€” if used, MUST have emergency rollback
- Jailbreak/root detection OPTIONAL â€” never rely on it for security
- All security MUST be enforced server-side â€” client is untrusted
